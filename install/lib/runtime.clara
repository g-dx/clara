// Linked List of all stack frames up to stack base
struct frame {
    next: frame
    caller: function
}

// Compile-time generated stack frame GC function
struct function {
    gc: fn(frame)
}

// Inserted by compiler to be called at start of `main()` before any other code
fn init() {
    setStackBase(getFramePointer().next) // Capture frame pointer of C 'main'
}

// Called from user code to crash the program
fn panic(cause: string) {
    printf("\n// -----------------------------------------------------------------------------\n")
    printf("// Panic: %s\n", cause)
    printf("// -----------------------------------------------------------------------------\n")
    abort()
}

// Invoked by an ASM trampoline (See codegen.go) for invalid array access
fn indexOutOfBounds(index: int) {
    printf("\n// -----------------------------------------------------------------------------\n")
    printf("// Crash: Index (%d) is out of bounds!\n", index)
    printf("// -----------------------------------------------------------------------------\n")
    printf("\nBacktrace:\nTODO!\n\n")
    // TODO: Output stacktrace
    abort()
}

// ---------------------------------------------------------------------------------------------------------------------
// External Functions
// ---------------------------------------------------------------------------------------------------------------------

// Source: libc, https://www.gnu.org/software/libc/manual/html_node/Aborting-a-Program.html#Aborting-a-Program
fn abort() nothing

fn getFramePointer() frame // Implemented in assembly by codegen.go
fn isStackBase(f: frame) bool
fn setStackBase(f: frame) nothing
